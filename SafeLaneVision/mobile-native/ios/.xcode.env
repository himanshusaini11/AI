#!/bin/sh
# .xcode.env
# Sourced by react-native-xcode.sh during iOS builds.
# Ensures Xcode can find a Node.js binary in non-interactive shells.

# Prepend common manager locations so `command -v` can find node
export PATH="$HOME/.volta/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"

# Hard override for our setup (update if Node path changes)
export NODE_BINARY="/opt/homebrew/bin/node"

# Try nvm if available to override the hardcoded path when appropriate
if [ -z "$NODE_BINARY" ] || [ ! -x "$NODE_BINARY" ]; then
  NVM_DIR="$HOME/.nvm"
  if [ -s "$NVM_DIR/nvm.sh" ]; then
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh" --no-use 2>/dev/null || true
    if command -v nvm >/dev/null 2>&1; then
      NVM_NODE_BIN="$(nvm which 2>/dev/null || true)"
      if [ -n "$NVM_NODE_BIN" ] && [ -x "$NVM_NODE_BIN" ]; then
        export NODE_BINARY="$NVM_NODE_BIN"
      fi
    fi
  fi
fi

# Fallback to common absolute paths or PATH lookup if NODE_BINARY is still unset
if [ -z "$NODE_BINARY" ] || [ ! -x "$NODE_BINARY" ]; then
  for CANDIDATE in \
    "$HOME/.volta/bin/node" \
    "/opt/homebrew/bin/node" \
    "/usr/local/bin/node" \
    "$(command -v node 2>/dev/null)"; do
    if [ -n "$CANDIDATE" ] && [ -x "$CANDIDATE" ]; then
      export NODE_BINARY="$CANDIDATE"
      break
    fi
  done
fi

# Final fallback: warn and leave NODE_BINARY as plain `node`
if [ -z "$NODE_BINARY" ] || [ ! -x "$NODE_BINARY" ]; then
  echo "warning: .xcode.env could not determine NODE_BINARY; defaulting to 'node'." >&2
  export NODE_BINARY=node
fi
