#!/bin/sh
# .xcode.env
# This file is sourced by React Native's iOS build script (react-native-xcode.sh).
# It ensures Xcode can find a working Node.js binary when building from Xcode/CI.

# Prepend common manager locations to PATH so command -v can find node
export PATH="$HOME/.volta/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"

# Try nvm if present to resolve the currently selected Node
if [ -z "$NODE_BINARY" ]; then
  NVM_DIR="$HOME/.nvm"
  if [ -s "$NVM_DIR/nvm.sh" ]; then
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh" --no-use 2>/dev/null || true
    if command -v nvm >/dev/null 2>&1; then
      # nvm which returns the absolute path to the current/default node
      NVM_NODE_BIN="$(nvm which 2>/dev/null || true)"
      if [ -n "$NVM_NODE_BIN" ] && [ -x "$NVM_NODE_BIN" ]; then
        export NODE_BINARY="$NVM_NODE_BIN"
      fi
    fi
  fi
fi

# If still not set, try common absolute locations and PATH lookup
if [ -z "$NODE_BINARY" ]; then
  for CANDIDATE in \
    "$HOME/.volta/bin/node" \
    "/opt/homebrew/bin/node" \
    "/usr/local/bin/node" \
    "$(command -v node 2>/dev/null)"; do
    if [ -n "$CANDIDATE" ] && [ -x "$CANDIDATE" ]; then
      export NODE_BINARY="$CANDIDATE"
      break
    fi
  done
fi

# Final fallback: leave as plain 'node' and warn; the RN script will try to use it
if [ -z "$NODE_BINARY" ]; then
  echo "warning: .xcode.env could not determine NODE_BINARY; defaulting to 'node'. Ensure Node is on PATH for Xcode." >&2
  export NODE_BINARY=node
fi
